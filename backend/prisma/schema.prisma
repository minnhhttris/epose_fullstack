// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}



enum Role {
  owner
  employee
  user
  admin
}

enum Status {
  active
  inactive
}

enum Statement {
  PAID // đã thanh toán
  CONFIRMED // xác nhận
  PENDING_PICKUP // chờ lấy hàng
  DELIVERING // đang giao
  DELIVERED // đã giao
  CANCELLED // đã hủy
  RETURNED // trả hàng
  COMPLETED // đã hoàn thành
}

model User {
  idUser        String    @id @default(uuid())
  email         String    @unique
  password_hash String
  userName      String?
  phoneNumbers  String?
  avatar        String?
  address       String?
  CCCD          String?   @unique
  CCCD_img      String[]
  gender        String?
  dateOfBirth   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  coins         Int       @default(0)
  role          Role      @default(user)     

  // Relations
  otp          OTP?
  storeUser    StoreUser[]
  posts        Posts[]
  comments     Comment[]
  bills        Bill[]
  bagShopping  BagShopping[]
  ratings      Rating[]
  attendance   Attendance[]
  notification Notification[]
  userVoucher  UserVoucher[]
  Favorite     Favorite[]

  sentMessages    Message[] @relation("UserSentMessages")
  receivedMessages Message[] @relation("UserReceivedMessages")
}

model OTP {
  idOTP     String   @id @default(uuid())
  code      String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  user      User?    @relation(fields: [idUser], references: [idUser])  // Khóa ngoại liên kết tới User
  idUser    String?  @unique
  createdAt DateTime @default(now())
}

model Store {
  idStore      String         @id @default(uuid())
  idUser       String 
  nameStore    String
  license      String         @unique
  taxCode      String         @unique
  logo         String
  address      String
  rate         Float          @default(0)
  status       Status         @default(inactive)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  // Relations
  user         StoreUser[]
  clothes      Clothes[]
  posts        Posts[]
  notification Notification[]
  bill         Bill[]

  sentMessages    Message[] @relation("StoreSentMessages")
  receivedMessages Message[] @relation("StoreReceivedMessages")
}

/////////////Clothes///////////
model Clothes {
  idItem      String        @id @default(uuid())
  nameItem    String
  description String
  price       Float
  listPicture String[]
  rate        Float
  favorite    Int
  color       Color
  style       Style
  gender      Gender
  number      Int           @default(0)
  idStore     String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  // Relations
  store       Store         @relation(fields: [idStore], references: [idStore])
  billItems   BillItem[]
  rating      Rating[]
  itemSizes   ItemSizes[]
  bagShopping BagShopping[]
}

enum Gender {
  male
  female
  unisex
}

enum Style {
  ao_dai
  tu_than
  co_phuc
  ao_ba_ba
  da_hoi
  nang_tho
  hoc_duong
  vintage
  ca_tinh
  sexy
  cong_so
  dan_toc
  do_doi
  hoa_trang
  cac_nuoc
}

enum Color {
  red
  blue
  green
  yellow
  black
  white
  pink
  purple
  orange
  brown
  gray
  beige
  colorfull
}

enum SizeEnum {
  S
  M
  L
  XL
}

model ItemSizes {
  idItemSize String   @id @default(uuid())
  idItem     String
  size       SizeEnum
  quantity   Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  // Relations
  clothes    Clothes  @relation(fields: [idItem], references: [idItem])

  @@unique([idItem, size])
}

model Rating {
  idRating      String   @id @default(uuid())
  idItem        String
  idUser        String
  ratingstar    Float
  ratingcomment String?
  createdAt     DateTime @default(now())
  // Relations
  user          User     @relation(fields: [idUser], references: [idUser])
  clothes       Clothes  @relation(fields: [idItem], references: [idItem])
}


//////////////Bill//////////////
model Bill {
  idBill      String     @id @default(uuid())
  idUser      String
  idStore     String
  sum         Float
  downpayment Float
  dateStart   DateTime
  dateEnd     DateTime
  statement   Statement
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  // Relations
  user        User       @relation(fields: [idUser], references: [idUser])
  store       Store      @relation(fields: [idStore], references: [idStore])
  billItems   BillItem[]
}

model BillItem {
  idBill  String
  idItem  String
  // Relations
  bill    Bill    @relation(fields: [idBill], references: [idBill])
  clothes Clothes @relation(fields: [idItem], references: [idItem])

  @@id([idBill, idItem])
}


///////////Posts////////////
model Posts {
  idPosts   String     @id @default(uuid())
  caption   String?
  picture   String[]
  favorite  Int        @default(0)
  idUser    String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  idStore   String
  // Relations
  user      User       @relation(fields: [idUser], references: [idUser])
  store     Store      @relation(fields: [idStore], references: [idStore])
  comments  Comment[]
  favorites Favorite[]
}

model Comment {
  idComment String   @id @default(uuid())
  idPosts   String
  idUser    String
  comment   String
  createdAt DateTime @default(now())
  // Relations
  user      User     @relation(fields: [idUser], references: [idUser])
  posts     Posts    @relation(fields: [idPosts], references: [idPosts])
}

model Notification {
  idNotification String   @id @default(uuid())
  idUser         String
  idStore        String
  notification   String
  createdAt      DateTime @default(now())
  // Relations
  user           User     @relation(fields: [idUser], references: [idUser])
  store          Store    @relation(fields: [idStore], references: [idStore])
}


////////////UserVoucher////////////
model UserVoucher {
  idUserVoucher String   @id @default(uuid())
  idUser        String
  idVoucher     String
  redeemedAt    DateTime @default(now())
  // Relations
  user          User     @relation(fields: [idUser], references: [idUser])
  voucher       Voucher  @relation(fields: [idVoucher], references: [idVoucher])
}

model Voucher {
  idVoucher     String        @id @default(uuid())
  description   String
  validFrom     DateTime
  validTo       DateTime
  dailyCheckIn  Boolean       @default(false)
  requiredCoins Int
  // Relations
  userVoucher   UserVoucher[]
}

model Message {
  idMessage     String   @id @default(uuid())
  message       String
  senderType    String   // 'USER' or 'STORE'
  receiverType  String   // 'USER' or 'STORE'
  senderId      String
  receiverId    String
  sendAt        DateTime @default(now())

  // Relations for polymorphic types
  senderUser    User?    @relation("UserSentMessages", fields: [senderId], references: [idUser], map: "SenderUser_fkey")
  senderStore   Store?   @relation("StoreSentMessages", fields: [senderId], references: [idStore], map: "SenderStore_fkey")
  receiverUser  User?    @relation("UserReceivedMessages", fields: [receiverId], references: [idUser], map: "ReceiverUser_fkey")
  receiverStore Store?   @relation("StoreReceivedMessages", fields: [receiverId], references: [idStore], map: "ReceiverStore_fkey")

  @@index([senderId, senderType])
  @@index([receiverId, receiverType])
}




model BagShopping {
  idBag   String  @id @default(uuid())
  idUser  String
  idItem  String
  // Relations
  user    User    @relation(fields: [idUser], references: [idUser])
  clothes Clothes @relation(fields: [idItem], references: [idItem])

  @@unique([idUser, idItem])
}

model Favorite {
  idFavorite String @id @default(uuid())
  idUser     String
  idPosts    String
  // Relations
  user       User   @relation(fields: [idUser], references: [idUser])
  posts      Posts  @relation(fields: [idPosts], references: [idPosts])

  @@unique([idUser, idPosts])
}

model StoreUser {
  idStore String
  idUser  String
  role    Role   @default(user)
  // Relations
  user    User   @relation(fields: [idUser], references: [idUser])
  store   Store  @relation(fields: [idStore], references: [idStore])

  @@id([idStore, idUser])
}

model Attendance {
  idAttendance String   @id @default(uuid())
  idUser       String
  checkInTime  DateTime @default(now())
  // Relations
  user         User     @relation(fields: [idUser], references: [idUser])

  @@unique([idUser, checkInTime])
}



